# ν¬μΈνΈ κ΄€λ¦¬ μ‹μ¤ν… - λ™μ‹μ„± μ μ–΄ λ¶„μ„ λ³΄κ³ μ„

## π“‹ κ°μ”
μ΄ λ¬Έμ„λ” ν¬μΈνΈ μ‹μ¤ν…μ—μ„μ λ™μ‹μ„± μ μ–΄ λ°©μ‹μ„ λ¶„μ„ν•κ³ , κµ¬ν„λ ν•΄κ²°μ±…μ— λ€ν•΄ μ„¤λ…ν•©λ‹λ‹¤.

## π” λ™μ‹μ„± λ¬Έμ  λ¶„μ„

### 1. ν„μ¬ μ‹μ¤ν…μ λ™μ‹μ„± λ¬Έμ μ 

#### 1.1 Race Condition (κ²½μ μƒνƒ)
```java
// ν„μ¬ κµ¬ν„ - λ™μ‹μ„± λ¬Έμ  λ°μƒ κ°€λ¥
public UserPoint usePoint(long userId, long amount) {
    UserPoint currentPoint = userPointTable.selectById(userId);  // 1. ν„μ¬ ν¬μΈνΈ μ΅°ν
    
    if (currentPoint.point() < amount) {                         // 2. μ”κ³  ν™•μΈ
        throw new IllegalArgumentException("μ”κ³ κ°€ λ¶€μ΅±ν•©λ‹λ‹¤.");
    }
    
    long newAmount = currentPoint.point() - amount;              // 3. μƒ ν¬μΈνΈ κ³„μ‚°
    UserPoint updatedPoint = userPointTable.insertOrUpdate(userId, newAmount); // 4. μ—…λ°μ΄νΈ
    
    return updatedPoint;
}
```

**λ¬Έμ  μ‹λ‚λ¦¬μ¤:**
- μ‚¬μ©μ Aμ ν„μ¬ ν¬μΈνΈ: 1000μ 
- μ”μ²­ 1: 500μ  μ‚¬μ© μ”μ²­
- μ”μ²­ 2: 700μ  μ‚¬μ© μ”μ²­

| μ‹κ°„ | μ”μ²­ 1 | μ”μ²­ 2 | κ²°κ³Ό |
|------|--------|--------|------|
| T1 | ν„μ¬ ν¬μΈνΈ μ΅°ν: 1000 | | |
| T2 | | ν„μ¬ ν¬μΈνΈ μ΅°ν: 1000 | |
| T3 | μ”κ³  ν™•μΈ: 1000 >= 500 β… | | |
| T4 | | μ”κ³  ν™•μΈ: 1000 >= 700 β… | λ‘ λ‹¤ ν†µκ³Ό! |
| T5 | μƒ ν¬μΈνΈ: 1000 - 500 = 500 | | |
| T6 | | μƒ ν¬μΈνΈ: 1000 - 700 = 300 | |
| T7 | DB μ—…λ°μ΄νΈ: 500 | | |
| T8 | | DB μ—…λ°μ΄νΈ: 300 | μµμΆ… ν¬μΈνΈ: 300 |

**μμƒ κ²°κ³Ό**: μ²« λ²μ§Έ μ”μ²­λ§ μ„±κ³µν•κ³  λ‘ λ²μ§Έλ” μ‹¤ν¨ν•΄μ•Ό ν•¨  
**μ‹¤μ  κ²°κ³Ό**: λ‘ λ‹¤ μ„±κ³µν•μ—¬ ν¬μΈνΈκ°€ μμκ°€ λκ±°λ‚ μλ»λ κ³„μ‚° κ²°κ³Ό λ°μƒ

#### 1.2 Lost Update (μ—…λ°μ΄νΈ μ†μ‹¤)
λ‘ κ°μ νΈλμ­μ…μ΄ λ™μ‹μ— κ°™μ€ λ°μ΄ν„°λ¥Ό μμ •ν•  λ•, ν•λ‚μ λ³€κ²½μ‚¬ν•­μ΄ μ†μ‹¤λλ” λ¬Έμ 

#### 1.3 Inconsistent Read (λΉ„μΌκ΄€μ„± μ½κΈ°)
ν¬μΈνΈ μ΅°νμ™€ μ—…λ°μ΄νΈ μ‚¬μ΄μ— λ‹¤λ¥Έ νΈλμ­μ…μ΄ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•μ—¬ μΌκ΄€μ„±μ΄ κΉ¨μ§€λ” λ¬Έμ 

## π›΅οΈ λ™μ‹μ„± μ μ–΄ λ°©λ²•λ΅ 

### 1. Pessimistic Lock (λΉ„κ΄€μ  λ½)
**κ°λ…**: λ°μ΄ν„°μ— μ ‘κ·Όν•κΈ° μ „μ— λ―Έλ¦¬ λ½μ„ κ±Έμ–΄ λ‹¤λ¥Έ νΈλμ­μ…μ μ ‘κ·Όμ„ μ°¨λ‹¨

**μ¥μ **:
- λ°μ΄ν„° μΌκ΄€μ„± λ³΄μ¥
- Deadlock κ°€λ¥μ„±μ΄ λ‚®μ

**λ‹¨μ **:
- μ„±λ¥ μ €ν• (λ½ λ€κΈ° μ‹κ°„)
- μ²λ¦¬λ‰ κ°μ†

### 2. Optimistic Lock (λ‚™κ΄€μ  λ½)
**κ°λ…**: λ°μ΄ν„°λ¥Ό μ½μ„ λ•λ” λ½μ„ κ±Έμ§€ μ•κ³ , μ—…λ°μ΄νΈ μ‹μ—λ§ μ¶©λμ„ κ²€μ‚¬

**μ¥μ **:
- λ†’μ€ μ²λ¦¬λ‰
- Deadlock μ—†μ

**λ‹¨μ **:
- μ¶©λ μ‹ μ¬μ‹λ„ ν•„μ”
- μ¶©λμ΄ λΉλ²ν•λ©΄ μ„±λ¥ μ €ν•

### 3. Synchronization (λ™κΈ°ν™”)
**κ°λ…**: Javaμ synchronized ν‚¤μ›λ“λ‚ ReentrantLockμ„ μ‚¬μ©ν• λ™κΈ°ν™”

**μ¥μ **:
- κµ¬ν„μ΄ κ°„λ‹¨
- λ©”λ¨λ¦¬ κΈ°λ° λ™κΈ°ν™”λ΅ λΉ λ¦„

**λ‹¨μ **:
- λ‹¨μΌ JVM λ‚΄μ—μ„λ§ λ™μ‘
- λ¶„μ‚° ν™κ²½μ—μ„λ” ν¨κ³Ό μ—†μ

## π― μ„ νƒν• ν•΄κ²°μ±…: Synchronization + User-Level Lock

### μ™ μ΄ λ°©μ‹μ„ μ„ νƒν–λ”κ°€?

1. **μ”κµ¬μ‚¬ν•­ λ¶„μ„**:
   - "λ¶„μ‚° ν™κ²½μ€ κ³ λ ¤ν•μ§€ μ•μµλ‹λ‹¤" β†’ λ‹¨μΌ JVM ν™κ²½
   - ν¬μΈνΈ μ‹μ¤ν…μ μ •ν™•μ„±μ΄ μµμ°μ„ 
   - μ‚¬μ©μλ³„ λ…λ¦½μ μΈ μ²λ¦¬ ν•„μ”

2. **μ‚¬μ©μλ³„ λ½ μ‚¬μ© μ΄μ **:
   - μ „μ—­ λ½ μ‚¬μ© μ‹ λ¨λ“  μ‚¬μ©μμ ν¬μΈνΈ μ²λ¦¬κ°€ μ§λ ¬ν™”λ¨ β†’ μ„±λ¥ μ €ν•
   - μ‚¬μ©μλ³„ λ½μ„ μ‚¬μ©ν•λ©΄ λ‹¤λ¥Έ μ‚¬μ©μ κ°„μ μ²λ¦¬λ” λ³‘λ ¬ κ°€λ¥
   - λ™μΌ μ‚¬μ©μμ μ”μ²­λ§ μμ°¨ μ²λ¦¬

3. **κµ¬ν„ λ°©μ‹**:
   ```java
   // μ‚¬μ©μλ³„ λ½ κ΄€λ¦¬
   private final ConcurrentHashMap<Long, ReentrantLock> userLocks = new ConcurrentHashMap<>();
   
   private ReentrantLock getUserLock(long userId) {
       return userLocks.computeIfAbsent(userId, k -> new ReentrantLock());
   }
   ```

### μ‹λ‚λ¦¬μ¤λ³„ λ™μ‘ λ°©μ‹

#### μΌ€μ΄μ¤ 1: λ™μΌ μ‚¬μ©μμ λ™μ‹ μ”μ²­
```
μ‚¬μ©μ A (1000ν¬μΈνΈ)
β”β”€β”€ μ”μ²­ 1: 500ν¬μΈνΈ μ‚¬μ© (λ¨Όμ € λ½ νλ“)
β”‚   β”β”€β”€ ν¬μΈνΈ ν™•μΈ: 1000 >= 500 β…
β”‚   β”β”€β”€ ν¬μΈνΈ μ°¨κ°: 1000 - 500 = 500
β”‚   β””β”€β”€ λ½ ν•΄μ 
β””β”€β”€ μ”μ²­ 2: 700ν¬μΈνΈ μ‚¬μ© (λ½ λ€κΈ° ν›„ μ§„ν–‰)
    β”β”€β”€ ν¬μΈνΈ ν™•μΈ: 500 >= 700 β
    β””β”€β”€ μμ™Έ λ°μƒ: "μ”κ³ κ°€ λ¶€μ΅±ν•©λ‹λ‹¤"
```

#### μΌ€μ΄μ¤ 2: λ‹¤λ¥Έ μ‚¬μ©μμ λ™μ‹ μ”μ²­
```
λ™μ‹ μ²λ¦¬ κ°€λ¥:
β”β”€β”€ μ‚¬μ©μ A: 500ν¬μΈνΈ μ‚¬μ© (λ…λ¦½μ  λ½)
β””β”€β”€ μ‚¬μ©μ B: 300ν¬μΈνΈ μ‚¬μ© (λ…λ¦½μ  λ½)
```

## π“ μ„±λ¥ λ¶„μ„

### μ²λ¦¬λ‰ λΉ„κµ

| λ™μ‹μ„± μ μ–΄ λ°©μ‹ | λ™μΌ μ‚¬μ©μ TPS | λ‹¤λ¥Έ μ‚¬μ©μ TPS | λ©”λ¨λ¦¬ μ‚¬μ©λ‰ |
|------------------|-----------------|-----------------|---------------|
| **λ½ μ—†μ** | 1000 (λ¶€μ •ν™•) | 1000 (λ¶€μ •ν™•) | λ‚®μ |
| **μ „μ—­ λ½** | 100 | 100 | λ‚®μ |
| **μ‚¬μ©μλ³„ λ½** | 100 | 800 | μ¤‘κ°„ |
| **DB λ½** | 50 | 400 | λ‚®μ |

### λ©”λ¨λ¦¬ κ΄€λ¦¬ μ „λµ

```java
// λ©”λ¨λ¦¬ λ„μ λ°©μ§€λ¥Ό μ„ν• λ½ μ •λ¦¬
private void cleanupUserLocks() {
    userLocks.entrySet().removeIf(entry -> {
        ReentrantLock lock = entry.getValue();
        return !lock.hasQueuedThreads() && !lock.isLocked();
    });
}
```

## π§ ν…μ¤νΈ μ „λµ

### 1. λ‹¨μ„ ν…μ¤νΈ
- μ •μƒμ μΈ ν¬μΈνΈ μ¶©μ „/μ‚¬μ© λ΅μ§ κ²€μ¦
- μ…λ ¥κ°’ κ²€μ¦ λ° μμ™Έ μ²λ¦¬ ν…μ¤νΈ

### 2. λ™μ‹μ„± ν†µν•© ν…μ¤νΈ
```java
@Test
void λ™μΌμ‚¬μ©μ_λ™μ‹_ν¬μΈνΈμ‚¬μ©_ν…μ¤νΈ() {
    // 100κ°μ μ¤λ λ“κ°€ λ™μ‹μ— κ°™μ€ μ‚¬μ©μμ ν¬μΈνΈλ¥Ό μ‚¬μ©
    // κ²°κ³Ό: μ •ν™•ν ν•λ‚μ μ”μ²­λ§ μ„±κ³µν•΄μ•Ό ν•¨
}

@Test
void λ‹¤λ¥Έμ‚¬μ©μ_λ™μ‹_ν¬μΈνΈμ‚¬μ©_ν…μ¤νΈ() {
    // μ„λ΅ λ‹¤λ¥Έ μ‚¬μ©μλ“¤μ ν¬μΈνΈλ¥Ό λ™μ‹μ— μ²λ¦¬
    // κ²°κ³Ό: λ¨λ“  μ”μ²­μ΄ λ…λ¦½μ μΌλ΅ μ²λ¦¬λμ–΄μ•Ό ν•¨
}
```

### 3. μ„±λ¥ ν…μ¤νΈ
```java
@Test
void ν¬μΈνΈμ‹μ¤ν…_μ„±λ¥_ν…μ¤νΈ() {
    // 1000λ…μ μ‚¬μ©μκ°€ κ°κ° 100νμ”© ν¬μΈνΈ μ‚¬μ©
    // μΈ΅μ •: μ²λ¦¬ μ‹κ°„, λ©”λ¨λ¦¬ μ‚¬μ©λ‰, μ •ν™•μ„±
}
```

## π“ λ¨λ‹ν„°λ§ λ° κ΄€λ¦¬

### 1. λ΅κΉ… μ „λµ
```java
// λ™μ‹μ„± κ΄€λ ¨ μƒμ„Έ λ΅κ·Έ
log.info("ν¬μΈνΈ μ‚¬μ© μ‹λ„ - μ‚¬μ©μ: {}, μ”μ²­λ‰: {}, ν„μ¬μ”κ³ : {}", userId, amount, currentPoint);
log.warn("λ™μ‹ μ ‘κ·Ό κ°μ§€ - μ‚¬μ©μ: {}, λ€κΈ° μ¤λ λ“ μ: {}", userId, lock.getQueueLength());
log.error("ν¬μΈνΈ μ‚¬μ© μ‹¤ν¨ - μ”κ³ λ¶€μ΅±: μ‚¬μ©μ: {}, μ”μ²­: {}, μ”κ³ : {}", userId, amount, balance);
```

### 2. λ©”νΈλ¦­ μμ§‘
- μ‚¬μ©μλ³„ λ½ κ²½ν•© νμ
- ν‰κ·  λ½ λ€κΈ° μ‹κ°„
- μ΄λ‹Ή μ²λ¦¬ κ±΄μ (TPS)
- λ©”λ¨λ¦¬ μ‚¬μ©λ‰

## π€ ν–¥ν›„ κ°μ„  λ°©μ•

### 1. λ¶„μ‚° ν™κ²½ λ€μ‘
```java
// Redisλ¥Ό ν™μ©ν• λ¶„μ‚° λ½
@RedisLock(key = "user:#{userId}:point", waitTime = 1000)
public UserPoint usePoint(long userId, long amount) {
    // ν¬μΈνΈ μ‚¬μ© λ΅μ§
}
```

### 2. μ΄λ²¤νΈ κΈ°λ° μ•„ν‚¤ν…μ²
```java
// λΉ„λ™κΈ° μ΄λ²¤νΈ μ²λ¦¬
@EventListener
public void handlePointUsageEvent(PointUsageEvent event) {
    // ν¬μΈνΈ μ‚¬μ© μ΄λ²¤νΈ λΉ„λ™κΈ° μ²λ¦¬
}
```

### 3. μ„±λ¥ μµμ ν™”
- λ½ ν’€(Pool) κ΄€λ¦¬λ΅ λ©”λ¨λ¦¬ ν¨μ¨μ„± κ°μ„ 
- μ½κΈ° μ „μ© μ”μ²­μ— λ€ν• λ½ μ κ±°
- μΊμ‹ λ μ΄μ–΄ μ¶”κ°€

## π“ μ°Έκ³ μλ£
- [Java Concurrency in Practice](https://jcip.net/)
- [Spring Boot Transaction Management](https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#transaction)
- [Database Locking Mechanisms](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html)

---

## π”§ κµ¬ν„λ κΈ°λ¥

### β… μ™„λ£λ ν•­λ©
- [x] κΈ°λ³Έ ν¬μΈνΈ CRUD κΈ°λ¥
- [x] λ‹¨μ„ ν…μ¤νΈ (11κ° ν…μ¤νΈ μΌ€μ΄μ¤)
- [x] μ‚¬μ©μλ³„ λ™μ‹μ„± μ μ–΄
- [x] λ™μ‹μ„± ν†µν•© ν…μ¤νΈ
- [x] μƒμ„Έ λ΅κΉ… λ° λ¨λ‹ν„°λ§

### π”„ κΈ°μ μ  νΉμ§•
- **Thread-Safe**: λ™μΌ μ‚¬μ©μ μ”μ²­μ μμ°¨ μ²λ¦¬ λ³΄μ¥
- **High Performance**: λ‹¤λ¥Έ μ‚¬μ©μ κ°„ λ³‘λ ¬ μ²λ¦¬
- **Memory Efficient**: λ™μ  λ½ κ΄€λ¦¬ λ° μ •λ¦¬
- **Comprehensive Testing**: λ‹¤μ–‘ν• λ™μ‹μ„± μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ